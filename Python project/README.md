# Data and Downloads
서울시 열린 데이터 광장(https://data.seoul.go.kr/)에서 ‘서울시 상권분석서비스(추정매출-상권배후지)’, ‘서울시 상권분석서비스(직장인구-상권배후지)’, ‘서울시 상권분석서비스(길단위인구-상권배후지)’와 ‘서울시 상권분석서비스(점포-상권배후지)’를 사용하였다.
* (추정매출-상권배후지) 데이터는 서울시 상권배후지 영역 내의 점포들의 추정 매출 정보를 나타낸다. 상권배후지가 코드로 나뉘어져 있고, 각 상권마다 그 상권에서의 서비스 업종과 업종에 대한 매출액을 나타낸다. 매출액은 월별, 주별, 일별, 시간대별, 연령대별 등으로 자세하게 세분화되어 있다. (직장인구-상권배후지), (길단위인구-상권배후지) 데이터들을 이 데이터에 merge 하였다.
* (직장인구-상권배후지) 데이터는 서울시 상권배후지 영역 내 직장이 위치한 인구 정보를 나타낸다. 상권배후지가 코드로 나뉘어져 있고, 각 상권마다 총 직장 인구수가 나타나 있다. 이는 성별, 연령대 등으로 세분화되어 있다.
* (길단위인구-상권배후지) 데이터는 서울시 상권배후지 영역 내의 생활인구 정보를 나타낸다. 상권배후지가 코드로 나뉘어져 있고, 각 상권마다 총 유동인구수가 나타나 있다. 이는 성별, 연령대 등으로 세분화되어 있다.
* (점포-상권배후지) 데이터는 서울시 상권배후지 영역 내의 점포 정보 및 개/폐업, 프랜차이즈 정보를 나타낸다. 상권배후지가 코드로 나뉘어져 있고, 각 상권마다 그 상권에서의 서비스 업종과 업종에 대한 점포수를 나타낸다. 이는 점포수, 유사 업종 점포수 등 다양한 형태로 나타난다.

Dataframe을 엑셀 파일(.xlsx)로 저장하기 위해 openpyxl 라이브러리를 설치, 사용하였다. (pip install openpyxl)

Machine Learning을 진행하기 위해 XGBoost 라이브러리를 설치, 사용하였다. (pip install XGBoost)

# Description of .py Files
## data_handling.py
- 4가지의 데이터를 전처리 하는 파일이다. (추정매출-상권배후지) 파일을 기준으로 '20rows.csv' 파일로 통합하였다.
- 분석의 용이성을 위해 기준_년분기_코드가 20231인 자료들만 사용하여 2023년 1분기 데이터들만 분석에 사용하였다.
- 점포수가 너무 적은 업종은 추천의 의미가 높지 않다고 생각하여(점포-상권배후지) 데이터를 이용하여 각 업종의 총 점포수가 10000개 미만인 업종은 계산에서 제외하였다. 이렇게 20개의 업종을 추릴 수 있었고, 각 상권마다 20개의 업종에 해당하는 row만 남겼다.
- 20개의 업종이 모든 상권에 존재하는 것이 아니기 때문에, 해당 상권에 없는 업종은 매출액을 0으로 처리하여 row를 추가하였다.
- 상권배후지_코드를 기준으로 점포수를 제외한 3개의 데이터를 통합하였다. 최종적으로는 상권배후지 코드와 코드명, 서비스 업종 코드와 코드명, 당월 매출 금액, 총 직장 인구수, 총 유동 인구수 column만 남겼다.
## Analyze.py
- 업종간 매출액 상관계수를 구하는 파일이다.
- 20개의 업종 간 각 쌍의 상관계수를 구한 이후 이를 21 X 21의 행렬로 만들어 이를 'Correlation_Table.xlsx' 파일로 저장한다.
- Testing을 위해 상관계수가 높은 상위 3개의 쌍만 출력하였다.
## Analyze2.py
- 호프-간이주점의 가중평균매출액을 계산한 후에 각 호프-간이주점에서 창업이 잘 될 것이라 예상되는 TOP5 상권정보를 출력하는 파일이다.
- 상관계수를 바탕으로 가중평균매출액을 구하는 일종의 Test 파일이다.
- Analyze.py의 분석과정에서 상관계수가 가장 높게 나왔던 호프-간이주점을 타겟 업종으로 가중평균매출액을 구하였다.
- 가중평균매출액은 특정 상권에서 특정 업종의 (다른 업종들과의 상관계수 * 다른 업종들의 매출액)을 한 이후에 이를 평균 처리한 것이기 때문에 가중평균매출액 대비 특정 업종의 매출액이 큰 상권에서 해당 업종의 창업이 잘 될 것이다.
    + 예를 들어 '마천1치안센터'에서 '한식음식점'의 가중평균매출액을 구하는 상황이라 가정해보자.
    + 먼저 한식음식점을 제외한 다른 19개의 업종들과의 상관계수를 구한다. 이렇게 되면 한식음식점과 나머지 19개의 업종에 대한 상관계수 데이터 19개가 나온다. 
    + 이후에 각 상관계수를 해당 업종의 매출액에 곱한다. (한식음식점 - 미용실 상관계수를 미용실 매출액에 곱하고, 한식음식점 - 노래방 상관계수를 노래방 매출액에 곱하고...)
    + 이 곱한 값들을 모두 평균 계산한 값이 '마천1치안센터'에서 '한식음식점'의 가중평균매출액이다.
- 이렇게 '호프-간이주점'의 가중평균매출액과 창업 TOP5 상권을 구한 후 이를 'Weighted_Avg_csv' 파일과 'Weighted_Avg_Ratio.xlsx'로 각각 저장한다.
- 여기에 평균 유동/직장 인구대비 TOP5 상권의 유동/직장인구 비율을 구하여 'without_ML.xlsx' 파일에 앞서 구한 가중평균매출액과 함께 나타낸다. (client에게 보다 판단할 수 있는 기준을 다양하게 제시하기 위함)
## Analyze3_ML.py
- 먼저, linear regression에 적합하고 최근 머신러닝 트렌드에서 핫하다는 library인 XGBoost model을 활용해보았다.
    + 상권의 총 매출을 예측하기 위하여, 데이터에서 필요한 column만 추출해낸 뒤 당월 매출 금액 예측 부분에 있어서는 MSDE값이 작게 나오도록 숫자를 보정해 numpy를 활용하여 log scale로 변환해 작업을 진행.
    + '기준_년분기_코드'를 사용해 DataFrame을 sort해줬고, 예측에 사용할 feature column으로는 '기준_년분기_코드' 와 '당월_매출_금액'을 사용하여 '다음_분기_총_매출_금액'을 예측하였다.
    분석에 사용할 feature column이 적어서, 학습 효율을 최대한 높이기 위해 hyper parameter중 eta(학습 효율, 기본값=0.3)을 0.8로 상향시켰고, max_tree_depth(트리의 최대 깊이, 기본값=3)도 6으로 상향 조정 해 주었다. 또한 수업에서 배웠던 MSE 변수를 사용하기에는 매출의 값이 워낙 크기에 오차 범위가 클 것이라 예측하여 RMSE로 변수 설정을 해 학습을 진행하였다. (Root를 씌우기 때문에 outlier element에 의한 오차가 비교적 줄어든다는 장점이 있다.) 그리고 학습에 사용할 트리 수도 비교적 많은 500이라는 숫자를 할당해 적은 feature column으로도 비교적 근사한 머신러닝 y값을 추출해 내려고 노력했다.

    + 일단 데이터 양이 꽤 되는 Rowdata로 데이터 학습을 해줬고, 그 과정에서 학습된 모델을 xgb_model.json 파일로 저장해줬다.
    + 이후 그 모델을 불러와 아까 만들어줬던 filtered_dfpop 라는 최종 파일에 대해 다음 분기 매출 예측을 진행시켜줬다.
    + 예측한 매출들을 DataFrame에 합쳐주고, 이를 FINAL.xlsx 파일로 저장해 주었다.
# Process of Project
## Step1
* 'data_handling.py' 파일을 실행시킨다.
* '20231_data.csv', '20231_population.csv', '20231_Streetpop.csv', 'merged.csv', '20rows.csv' 파일이 생성된다.
## Step2
* 'Analyze.py' 파일을 실행시킨다.
* 'Correlation_Table.xlsx' 파일이 생성된다. 이 파일에서 각 업종의 상관계수를 확인할 수 있다.
## Step3
* 'Analyze2.py' 파일을 실행시킨다.
* 'Weighted_Avg.csv' 파일과 'Weighted_Avg_Ratio.xlsx' 파일이 생성된다. 'Weighted_Avg_Ratio.xlsx' 파일에서 호프-간이주점의 상권별 가중평균매출액을 확인할 수 있다.
* 'without_ML.xlsx' 파일이 생성된다. 이 파일에서 호프-간이주점 업종의 창업을 추천하는 상권과 해당 상권의 유동/직장인구 비율을 확인할 수 있다.
## Step4
* 'Analyze3_ML.py' 파일을 실행시킨다.
* 'new_data_with_predictions.csv' 파일이 생성된다. '호프-간이주점'의 창업 추천 상권의 다음 분기 매출액을 예측하여 나타낸다.
* 'FINAL.xlsx' 파일이 생성된다. 지금까지 구한 모든 파일들을 합쳐서 '호프-간이주점' 업종의 창업을 추천하는 상위 다섯개의 상권과 해당 상권의 유동/직장인구 비율, 그리고 다음 분기 매출액을 확인할 수 있다.
